=== Initial files

There are few files that are required in the cluster's file directory of the
internal configuration repository to deploy the generic service nodes.

First, create the needed sub-directories:

----
mkdir -p $ADMIN/hpc-privatedata/files/$CLUSTER/boot/ipxe \
         $ADMIN/hpc-privatedata/files/$CLUSTER/boot/disk-installer/scibian9 \
         $ADMIN/hpc-privatedata/files/$CLUSTER/boot/cgi
----

==== Debian installer

The debian installer archive can be built with the content of the
`debian-installer-9-netboot-amd64` package. This should be sufficient in most
cases, if the hardware needs special modules or firmwares during install, it
should be modified.

----
# apt-get install debian-installer-9-netboot-amd64
# tar chzf $ADMIN/hpc-privatedata/files/$CLUSTER/boot/disk-installer/scibian9/netboot.tar.gz -C /usr/lib/debian-installer/images/9/amd64/text .
----

==== iPXE binary

The iPXE ROM must be built from sources downloaded on
http://ipxe.org/[iPXE website]:

----
# wget https://git.ipxe.org/ipxe.git/snapshot/HEAD.tar.gz -O $ADMIN/ipxe.tar.gz
# tar -C $ADMIN -xzf $ADMIN/ipxe.tar.gz
# cd $ADMIN/ipxe-*/src
----

A small script is added to  retries DHCP requests until it succeeds in obtaining
a boot filename, as documented in http://ipxe.org/embed[iPXE official documentation].

----
#!ipxe
  
  :retry_dhcp
  dhcp && isset ${filename} || goto retry_dhcp
  echo Booting from ${filename}
  chain ${filename}
----

This is a workaround if DHCP requests are lost when booting a large number of nodes
simultaneously.
The "EMBED" option must be used for the compilation :

----
# make bin/undionly.kpxe EMBED=dhcp_retry.ipxe
# cp bin/undionly.kpxe $ADMIN/hpc-privatedata/files/$CLUSTER/boot/ipxe/ipxe_noserial.bin
----

The `ipxe_serial.bin` variant must be generated after modifying hard-coded
serial console parameters in iPXE source code as documented in
http://ipxe.org/console[iPXE official documentation].

To build the serial binary on default serial port (COM1/ttyS0):

----
# make -j 16 bin/undionly.kpxe CONSOLE_SERIAL EMBED=dhcp_retry.ipxe
# cp bin/undionly.kpxe $ADMIN/hpc-privatedata/files/$CLUSTER/boot/ipxe/ipxe_serial.bin
----

==== Bootmenu

The iPXE menu boot entries are generated dynamically, depending on the source
node name, by the CGI Python script
`$ADMIN/hpc-privatedata/files/$CLUSTER/boot/cgi/bootmenu.py`:

[source,python]
----
include::../../examples/bootmenu.py[]
----

////
NOTE: the bootmenu can be removed from this section once this bug is fixed:
  https://github.com/edf-hpc/puppet-hpc/issues/82
////

==== Partition schema

Debian installer partman utility requires a partition schema with rules and
constraints to create the disk partitions. This file must is located in
`$ADMIN/hpc-privatedata/files/$CLUSTER/boot/disk-installer/scibian9/partition-schema`.
Here is a complete example for this file:

[source]
----
include::../../examples/partition-schema[]
----
